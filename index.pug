doctype html
html(ng-app="app")
  head
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1")
    title= title
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css")
    link(rel="stylesheet", href="gallery.css")
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    link(rel="stylesheet", href="jquery.fancybox.min.css")
    link(rel="stylesheet", href="main.css")
    link(rel="stylesheet", href="css/advanced-features.css")
  
  body#top
    div(class="container-fluid py-3" id="controller" ng-controller="photoController")
      div.text-center.my-3(ng-if="loading")
        div.spinner-border.text-primary(role="status")
          span.visually-hidden Loading...  
      // Header
      header.collapsible-header.d-flex.flex-column.sticky-top.bg-white.border-bottom.shadow-sm.px-2.py-2(combo-header)
        // First row: Logo, Album, Controls
        div.d-flex.align-items-center.flex-nowrap.w-100
          img(src="/favicon.png" alt="Home" width="28" class="me-2")
          h6.mb-0.flex-grow-1.text-truncate {{selectedAlbum.name}}
          div.d-flex.align-items-center.ms-auto.gap-2.flex-nowrap
            // Search buttons (Basic + Advanced)
            div.btn-group
              button.btn.btn-outline-primary.btn-sm(
                type="button" 
                data-bs-toggle="modal" 
                data-bs-target="#searchModal"
                title="Quick search"
              )
                i.fas.fa-search
              
              button.btn.btn-outline-info.btn-sm(
                type="button"
                onclick="window.advancedSearch && window.advancedSearch.toggle()"
                title="Advanced search with filters"
              )
                i.fas.fa-search-plus

            // Upload button
            button.btn.btn-outline-success.btn-sm(
              type="button"
              ng-click="selectUploadFile()"
            )
              i.fas.fa-upload.me-1

            // Hamburger menu (aligned right)
            button.btn.btn-outline-secondary.btn-sm.d-md-none(
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#folderSidebar"
              aria-expanded="false"
              aria-controls="folderSidebar"
            )
              i.fas.fa-bars

        // Pagination Controls
        // Second row: Pagination + Page Info
        div.d-flex.justify-content-between.align-items-center.mt-1.w-100
          button.btn.btn-outline-secondary.btn-sm(
            ng-click="prevPage()"
            ng-disabled="pageId === 0 || loading"
          )
            i.fas.fa-chevron-left.me-1
            | Prev

          input.form-control.form-control-sm.text-center(
            type="number"
            ng-model="numberOfItemsOnPage"
            min="1"
            style="max-width:70px;"
            title="Number of items per page"
          )

          // Page info
          div.small.text-muted
                | Page {{pageId + 1}} of {{totalPages}} ({{totalPhotos}} photos)

          button.btn.btn-outline-secondary.btn-sm(
            ng-click="nextPage()"
            ng-disabled="noMorePhotos || loading"
          )
            | Next
            i.fas.fa-chevron-right.ms-1

        // Third row: Progress Bar
        div.progress.mt-1(style="height: 4px;")
          div.progress-bar.bg-primary(
            role="progressbar"
            ng-style="{'width': ((pageId + 1) / totalPages * 100) + '%'}"
            aria-valuemin="0"
            aria-valuemax="100"
          )

      //- Advanced Search Panel
      div#advanced-search-container

      // Sidebar + Content
      div.row
        // Sidebar for Folders
        aside#folderSidebar.col-md-2.mb-3.collapse.d-md-block(ng-if="folders.length > 0")
          div.albums-sidebar
            h6.albums-title
              i.fas.fa-folder-open.me-2
              | Albums
            
            //- Albums search
            div.albums-search
              input.form-control.form-control-sm(
                type="text"
                ng-model="albumsSearchText"
                placeholder="Search albums..."
                title="Search albums by name"
                id="albumsSearchInput"
              )
              button.btn-albums-clear(
                ng-style="albumsSearchText ? {opacity: 1, 'pointer-events': 'all'} : {opacity: 0, 'pointer-events': 'none'}"
                ng-mousedown="albumsSearchText = ''"
                type="button"
                title="Clear search"
              )
                i.fas.fa-times
            
            //- All Albums button
            button.btn.btn-sm.btn-outline-primary.w-100.mb-2(
              ng-click="setAlbum({album: '', path: ''})"
              ng-class="{'active': selectedAlbum.album == '' || !selectedAlbum.album}"
              style="font-size: 0.85rem;"
            )
              i.fas.fa-th.me-1
              | All Albums
              span.badge.bg-primary.float-end {{(folders | filter:{album: albumsSearchText}).length}}
            
            //- Favorites button
            button.btn.btn-sm.btn-outline-danger.w-100.mb-2(
              ng-click="viewFavorites()"
              ng-class="{'active': selectedAlbum.album == 'favorites'}"
              style="font-size: 0.85rem;"
              title="View all favorite media"
            )
              i.bi.bi-heart-fill.me-1
              | Favorites
              span.badge.bg-danger.float-end {{favoritesCount}}
            
            //- Albums list (filtered)
            ul.list-group.list-group-flush.albums-list
              li.list-group-item.list-group-item-action.album-item(
                ng-repeat="folder in folders | filter:{album: albumsSearchText}"
                ng-click="setAlbum(folder)"
                ng-class="{'active': folder.album == selectedAlbum.album}"
                title="{{folder.album}}"
              )
                div.album-name
                  i.fas.fa-folder.me-2
                  span {{folder.album}}
            
            //- No results message
            div.albums-no-results(
              ng-if="albumsSearchText.trim() && (folders | filter:{album: albumsSearchText}).length === 0"
            )
              i.fas.fa-search.me-2
              | No albums found

        // Main Content
        main(ng-class="{'col-md-10': folders.length > 0, 'col-12': folders.length == 0}")
          // Gallery Grid
          div.row.g-3
            div.col-sm-6.col-md-4.col-lg-3(ng-repeat="image in photos")
              div.card.shadow-sm(style="position: relative;")
                //- Checkbox for bulk operations
                input.photo-checkbox(
                  type="checkbox"
                  ng-attr-data-photo-id="{{image.path}}"
                  style="position: absolute; bottom: 10px; right: 10px; z-index: 5; width: 20px; height: 20px; cursor: pointer;"
                  title="Select for bulk operations"
                )
                a(
                  ng-if="!image.isAudio"
                  ng-href="{{image.path}}"
                  data-fancybox="gallery"
                  data-caption="{{image.tags}}"
                  ng-attr-data-type="{{image.isAudio ? 'iframe' : (image.isVideo ? 'video' : (image.isPdf ? 'iframe' : 'image'))}}"
                  ng-attr-data-width="{{image.isVideo ? '640' : undefined}}"
                  ng-attr-data-height="{{image.isVideo ? '360' : undefined}}"
                )
                  figure
                    img.card-img-top.img-fluid(
                      ng-src="{{image.isAudio ? 'music.png' : (image.isVideo ? '/thumbs?id=' + image.path + '&w=300&h=200' : (image.isPdf ? 'pdf.png' : '/thumbs?id=' + image.path + '&w=300&h=200'))}}"
                      alt="{{image.tags}}"
                      loading="lazy"
                      style="object-fit: contain; width: 100%; height: auto;"
                    )
                    i.overlay-icon(
                      ng-class="{'fas fa-play-circle': image.isAudio || image.isVideo,'fas fa-file-pdf': image.isPdf,'fas fa-search-plus': image.isPhoto}"
                    )
                div.card-body.p-2
                  h6.card-title.mb-1.text-truncate
                    a.text-decoration-none.text-dark(
                      href="javascript:void(0)"
                      ng-click="editImageTag(image)"
                      title="Edit tags"
                    ) {{image.tags || 'Untitled'}}
                  
                  //- Action buttons for advanced features
                  div.d-flex.gap-1.mt-2(ng-if="!image.isAudio && !image.isPdf")
                    button.btn.btn-sm.btn-outline-info(
                      type="button"
                      ng-click="showExifModal(image)"
                      title="View EXIF data"
                    )
                      i.fas.fa-camera.fa-sm
                    
                    button.btn.btn-sm.btn-outline-danger(
                      type="button"
                      ng-click="toggleFavorite(image)"
                      ng-class="{'active': image.isFavorite}"
                      title="Favorite"
                    )
                      i.fas.fa-heart.fa-sm
                    
                    button.btn.btn-sm.btn-outline-success(
                      type="button"
                      ng-click="sharePhoto(image)"
                      title="Share photo"
                    )
                      i.fas.fa-share-alt.fa-sm
        // Audio Player Bar
        div#playerBar.fixed-bottom.bg-light.border-top.p-2(ng-if="playlist.length > 0")
          div.d-flex.align-items-center
            i.fas.fa-music.me-2
            strong.me-2 {{ playlist[currentIndex].tags || 'Untitled' }}

            // Controls
            button.btn.btn-sm.btn-outline-secondary.me-2(ng-click="prev()")
              i.fas.fa-backward
            button.btn.btn-sm.btn-outline-primary.me-2(ng-click="togglePlay()")
              i(ng-class="{'fas fa-pause': isPlaying, 'fas fa-play': !isPlaying}")
            button.btn.btn-sm.btn-outline-secondary.me-2(ng-click="next()")
              i.fas.fa-forward

            // Progress bar
            div.flex-grow-1.mx-2.progress-bar-container(
              ng-click="seek($event)"
              style="height:6px; background:#ddd; cursor:pointer; position:relative;"
            )
              div(style="height:100%; background:#4285f4; width:{{progress}}%;")

            small.text-muted.ms-2 {{ currentTime }} / {{ duration }}

          // Playlist display
          div.mt-2(style="max-height:150px; overflow-y:auto;")
            ul.list-group
              li.list-group-item(
                ng-repeat="track in playlist track by $index"
                ng-class="{'active': $index === currentIndex}"
                ng-click="playAudio(track)"
                style="cursor:pointer;"
              )
                i.fas.fa-music.me-2
                | {{ track.tags || 'Untitled' }}   
      button#goTopBtn.btn.btn-primary.rounded-circle.shadow(
        ng-click="scrollToTop()"
        title="Go to top"
      )
        i.fas.fa-arrow-up

      //- Edit Tag Modal
      div.modal.fade#editTagModal(tabindex="-1" aria-labelledby="editTagModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#editTagModalLabel Update photo description
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              //- Show selected image if it's a photo
              img.img-fluid#selectedFile(
                ng-if="selectedPhoto.isPhoto"
                ng-src="{{selectedPhoto.path}}"
                width="225"
                height="150"
              )

              form(name="editTagForm" novalidate)
                input(type="hidden" name="id" ng-value="selectedPhoto.id")
                input(type="hidden" name="name" ng-value="selectedPhoto.path")

                .mb-3
                  label.form-label(for="tags") Tags
                  select.form-select(
                    id="tags"
                    ng-model="selectedOption"
                    ng-change="selectedTag = selectedOption"
                  )
                    option(ng-repeat="tag in tags" value="{{tag.tags}}") {{tag.tags}}

                .mb-3
                  label.form-label(for="desc") Description
                  textarea.form-control#desc(
                    name="tags"
                    rows="4"
                    cols="80"
                    ng-model="selectedPhoto.tags"
                  )

            div.modal-footer
              button.btn.btn-primary(
                type="button"
                ng-click="submitEditTagForm()"
                data-bs-dismiss="modal"
              ) Update
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel

      //- Search Modal
      div.modal.fade#searchModal(tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#searchModalLabel Search
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              input.form-control(type="text" placeholder="Type to search..." ng-model="searchTag" ng-keypress="($event.which === 13) && search()")
              div.mt-3
                h6.text-muted Tags
                div.d-flex.flex-wrap.gap-2
                  a.badge.bg-secondary.text-white.text-decoration-none(
                    ng-repeat="tag in filteredTags"
                    ng-click="searchByTag(tag.tag)"
                    style="cursor: pointer;"
                  ) {{tag.tag}}
            div.modal-footer
              button.btn.btn-primary(type="button" ng-click="search()" data-bs-dismiss="modal") Search
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close
      
      //- EXIF Details Modal
      div.modal.fade#exifModal(tabindex="-1" aria-labelledby="exifModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered.modal-lg
          div.modal-content
            div.modal-header
              h5.modal-title#exifModalLabel ðŸ“¸ Photo Details
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body#exif-modal-body
              p.text-center.text-muted Loading EXIF data...
            div.modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close
      
      //- File upload Modal
      div.modal.fade#uploadModal(tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#uploadModalLabel Upload File
              button.btn-close(type="button", data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              form(name="uploadForm" novalidate)
                div.mb-3
                  label.form-label(for="uploadFile") Select File                  
                  input.form-control(type="file" id="uploadFile" name="myFile" file-model="uploadFile" accept="*/*" required)
                img.img-fluid.mt-2(ng-if="filePreviewUrl" ng-src="{{filePreviewUrl}}")
                div.mb-3
                  label.form-label Enter file description
                  textarea.form-control(name="tags" ng-model="uploadTags" rows="3")
                div.mb-3
                  label.form-label Select folder OR enter name
                  div.d-flex.gap-2
                    select.form-select(
                      ng-model="uploadAlbum"
                      ng-options="album.path as album.name for album in albums"
                    )
                    input.form-control(type="text" name="album" ng-model="uploadAlbum")
            div.modal-footer
              button.btn.btn-primary(type="button" ng-click="submitUploadForm()" data-bs-dismiss="modal") Upload
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
    // Scripts
    script(src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.18/angular-ui-router.min.js")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
    script(src="jquery/jquery.min.js")
    script(src="jquery.fancybox.min.js")
    script(src="js/ng-app.js")    
    script(src="main.js")
    script(src="js/controllers/photoController.js")
    script(src="js/directives/modalDirective.js")
    script(src="js/directives/fileModelDirective.js")
    script(src="js/directives/shrinkHeaderDirective.js")
    script(src="js/services/photoService.js")
    script(src="js/services/modalService.js")
    
    //- Advanced Features Components
    script(src="js/advanced-search.js")
    script(src="js/exif-display.js")
    script(src="js/bulk-operations.js")
    script(src="js/social-features.js")
    script(src="js/advanced-features-angular-integration.js")
    
