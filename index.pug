doctype html
html(ng-app="app")
  head
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1")
    title= title
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css")
    link(rel="stylesheet", href="gallery.css")
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    link(rel="stylesheet", href="jquery.fancybox.min.css")
    link(rel="stylesheet", href="main.css")
    link(rel="stylesheet", href="css/advanced-features.css")
    link(rel="stylesheet", href="css/music-player.css")
  
  body#top
    div(class="container-fluid py-3" id="controller" ng-controller="photoController")
      div.text-center.my-3(ng-if="loading")
        div.spinner-border.text-primary(role="status")
          span.visually-hidden Loading...  
      // Header
      header.collapsible-header.d-flex.flex-column.sticky-top.bg-white.border-bottom.shadow-sm.px-2.py-2(combo-header)
        // First row: Logo, Album, Controls
        div.d-flex.align-items-center.flex-nowrap.w-100
          img(src="/favicon.png" alt="Home" width="28" class="me-2")
          h6.mb-0.flex-grow-1.text-truncate {{selectedAlbum.name}}
          div.d-flex.align-items-center.ms-auto.gap-2.flex-nowrap
            // Search buttons (Basic + Advanced)
            div.btn-group
              button.btn.btn-outline-primary.btn-sm(
                type="button" 
                data-bs-toggle="modal" 
                data-bs-target="#searchModal"
                title="Quick search (Ctrl+K)"
              )
                i.fas.fa-search
              
              button.btn.btn-outline-info.btn-sm(
                type="button"
                onclick="window.advancedSearch && window.advancedSearch.toggle()"
                title="Advanced search with filters"
              )
                i.fas.fa-search-plus

            // Upload button
            button.btn.btn-outline-success.btn-sm(
              type="button"
              ng-click="selectUploadFile()"
            )
              i.fas.fa-upload.me-1

            // Cache management dropdown
            div.dropdown
              button.btn.btn-outline-warning.btn-sm.dropdown-toggle(
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="Cache management"
              )
                i.fas.fa-database
              ul.dropdown-menu.dropdown-menu-end
                li
                  a.dropdown-item(href="#" data-bs-toggle="modal" data-bs-target="#cacheStatsModal")
                    i.fas.fa-chart-pie.me-2
                    | Cache Stats
                li
                  hr.dropdown-divider
                li
                  a.dropdown-item(href="#" ng-click="scanForNewAlbums()")
                    i.fas.fa-sync.me-2
                    | Scan for New Albums
                li
                  a.dropdown-item(href="#" ng-click="clearCurrentAlbumCache()")
                    i.fas.fa-eraser.me-2
                    | Clear Current Album
                li
                  a.dropdown-item(href="#" ng-click="clearAllCache()")
                    i.fas.fa-trash.me-2
                    | Clear All Cache

            // Hamburger menu (album toggle)
            button.btn.btn-outline-secondary.btn-sm(
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#folderSidebar"
              aria-expanded="false"
              aria-controls="folderSidebar"
              title="Toggle albums sidebar"
            )
              i.fas.fa-bars

        // Pagination Controls
        // Second row: Pagination + Page Info
        div.d-flex.justify-content-between.align-items-center.mt-1.w-100
          button.btn.btn-outline-secondary.btn-sm(
            ng-click="prevPage()"
            ng-disabled="pageId === 0 || loading"
          )
            i.fas.fa-chevron-left.me-1
            | Prev

          input.form-control.form-control-sm.text-center(
            type="number"
            ng-model="numberOfItemsOnPage"
            min="1"
            style="max-width:70px;"
            title="Number of items per page"
          )

          // Page info
          div.small.text-muted
                | Page {{pageId + 1}} of {{totalPages}} ({{totalPhotos}} photos)

          button.btn.btn-outline-secondary.btn-sm(
            ng-click="nextPage()"
            ng-disabled="noMorePhotos || loading"
          )
            | Next
            i.fas.fa-chevron-right.ms-1

        // Third row: Progress Bar
        div.progress.mt-1(style="height: 4px;")
          div.progress-bar.bg-primary(
            role="progressbar"
            ng-style="{'width': ((pageId + 1) / totalPages * 100) + '%'}"
            aria-valuemin="0"
            aria-valuemax="100"
          )

      //- Advanced Search Panel
      div#advanced-search-container

      // Sidebar + Content
      div.row
        // Sidebar for Folders
        aside#folderSidebar.col-md-2.mb-3.collapse.d-md-block
          div.albums-sidebar
            div.albums-header
              //- Toggle between Albums and Playlists
              div.btn-group.w-100(role="group" style="margin-bottom: 0.5rem;")
                button.btn.btn-sm.btn-outline-primary(
                  type="button"
                  ng-click="switchView('albums')"
                  ng-class="{'active': selectedView === 'albums'}"
                  style="flex: 1; font-size: 0.75rem; padding: 0.3rem 0.5rem;"
                  title="View albums"
                )
                  i.fas.fa-folder-open.me-1
                  | Albums
                button.btn.btn-sm.btn-outline-success(
                  type="button"
                  ng-click="switchView('playlists')"
                  ng-class="{'active': selectedView === 'playlists'}"
                  style="flex: 1; font-size: 0.75rem; padding: 0.3rem 0.5rem;"
                  title="View playlists"
                )
                  i.fas.fa-list.me-1
                  | Playlists
              
              //- Albums title with back button
              div.albums-title-row(ng-if="selectedView === 'albums'")
                h6.albums-title
                  i.fas.fa-folder-open.me-2
                  | Albums
                button.btn.btn-sm.btn-outline-secondary.back-button(
                  ng-if="selectedView === 'albums'"
                  ng-click="goToParentAlbum()" 
                  ng-disabled="!getParentAlbum()"
                  title="Back to parent album"
                )
                  i.fas.fa-arrow-left.me-1
                  | Back
                  
              h6.albums-title(ng-if="selectedView === 'playlists'" style="margin-top: 0.5rem; margin-bottom: 0;")
                i.fas.fa-list.me-2
                | Playlists
            
            //- Albums search
            div.albums-search(ng-if="selectedView === 'albums'")
              input.form-control.form-control-sm(
                type="text"
                ng-model="albumsSearchText"
                ng-keyup="onSearchChange('albums', $event)"
                placeholder="Search albums..."
                title="Search albums by name"
                id="albumsSearchInput"
                style="padding-right: 30px;"
              )
              button.btn-albums-clear(
                ng-show="albumsSearchText"
                ng-click="clearAlbumsSearch()"
                type="button"
                title="Clear search"
              )
                i.fas.fa-times
            
            //- Playlists search
            div.albums-search(ng-if="selectedView === 'playlists'")
              input.form-control.form-control-sm(
                type="text"
                ng-model="playlistsSearchText"
                ng-keyup="onSearchChange('playlists', $event)"
                placeholder="Search playlists..."
                title="Search playlists by name"
                id="playlistsSearchInput"
                style="padding-right: 30px;"
              )
              button.btn-albums-clear(
                ng-show="playlistsSearchText"
                ng-click="clearPlaylistsSearch()"
                type="button"
                title="Clear search"
              )
                i.fas.fa-times
              
              //- Create new playlist button
              button.btn.btn-sm.btn-outline-success.w-100(
                ng-click="openCreatePlaylistModal()"
                style="font-size: 0.75rem; padding: 0.3rem 0.5rem; margin-top: 0.5rem;"
                title="Create a new playlist"
              )
                i.fas.fa-plus.me-1
                | New Playlist
            
            //- All Albums button (Albums view)
            button.btn.btn-sm.btn-outline-primary.w-100(
              ng-if="selectedView === 'albums'"
              ng-click="setAlbum({album: '', path: ''})"
              ng-class="{'active': selectedAlbum.album == '' || !selectedAlbum.album}"
              style="font-size: 0.75rem; padding: 0.3rem 0.5rem; margin-bottom: 4px;"
            )
              i.fas.fa-th.me-1
              | All Albums
              span.badge.bg-primary.float-end {{getFilteredFolders().length}}
            
            //- All Playlists button (Playlists view)
            button.btn.btn-sm.btn-outline-primary.w-100(
              ng-if="selectedView === 'playlists'"
              ng-click="setAlbum({album: '', path: ''})"
              ng-class="{'active': selectedAlbum.album == '' || !selectedAlbum.album}"
              style="font-size: 0.75rem; padding: 0.3rem 0.5rem; margin-bottom: 4px;"
            )
              i.fas.fa-list.me-1
              | All Playlists
              span.badge.bg-primary.float-end {{getFilteredPlaylists().length}}
            
            //- Favorites button
            button.btn.btn-sm.btn-outline-danger.w-100(
              ng-click="viewFavorites()"
              ng-class="{'active': selectedAlbum.album == 'favorites'}"
              style="font-size: 0.75rem; padding: 0.3rem 0.5rem; margin-bottom: 4px;"
              title="View all favorite media"
            )
              i.bi.bi-heart-fill.me-1
              | Favorites
              span.badge.bg-danger.float-end {{favoritesCount}}
            
            //- Recently Viewed Section (hidden by default)
            div.recently-viewed-section(ng-if="recentlyViewed.length > 0 && showRecentlyViewed")
              div.d-flex.justify-content-between.align-items-center
                h6(style="font-size: 0.75rem; margin: 0;")
                  i.fas.fa-clock.me-1
                  | Recent
                div.d-flex.gap-1
                  button.btn.btn-link.p-0(
                    ng-click="clearRecentlyViewed()"
                    title="Clear recently viewed"
                    style="font-size: 0.6rem; text-decoration: none; padding: 2px !important;"
                  )
                    i.fas.fa-trash
                  button.btn.btn-link.p-0(
                    ng-click="toggleRecentlyViewed()"
                    title="Hide recently viewed"
                    style="font-size: 0.6rem; text-decoration: none; padding: 2px !important;"
                  )
                    i.fas.fa-times
              
              ul.list-group.list-group-flush
                li.list-group-item.list-group-item-action.recent-item(
                  ng-repeat="item in recentlyViewed"
                  ng-click="viewRecentAlbum(item)"
                  title="{{item.name}} - {{formatRecentTime(item.timestamp)}}"
                )
                  div.d-flex.justify-content-between.align-items-center
                    div.text-truncate
                      i.fas.fa-folder.text-muted
                      span {{item.name}}
                    span.badge.bg-secondary(style="font-size: 0.6rem;" ng-if="item.photoCount") {{item.photoCount}}
            
            //- Toggle Recently Viewed (shown when there are items and list is hidden)
            button.btn.btn-sm.btn-outline-secondary.w-100(
              ng-if="recentlyViewed.length > 0 && !showRecentlyViewed"
              ng-click="toggleRecentlyViewed()"
              style="font-size: 0.75rem; padding: 0.3rem 0.5rem; margin-bottom: 4px;"
              title="Show recently viewed albums"
            )
              i.fas.fa-clock.me-1
              | Show Recent ({{recentlyViewed.length}})
            
            //- Albums list (filtered)
            ul.list-group.list-group-flush.albums-list(ng-if="selectedView === 'albums'")
              li.list-group-item.list-group-item-action.album-item(
                ng-repeat="folder in getFilteredFolders()"
                ng-class="{'active': folder.album == selectedAlbum.album}"
                title="{{folder.album}}"
                style="position: relative; padding-right: 45px;"
              )
                div.d-flex.justify-content-between.align-items-center
                  div(ng-click="setAlbum(folder)" style="flex-grow: 1; cursor: pointer;")
                    div.album-name
                      i.fas.fa-folder.me-2
                      span {{folder.album}}
                    //- Display album tags if they exist
                    div.album-tags(ng-if="folder.tags && folder.tags.trim()" style="margin-top: 0.3rem; margin-left: 1.5rem;")
                      span.badge.bg-info.me-1(
                        ng-repeat="tag in folder.tags.split(',')"
                        ng-if="tag.trim()"
                        style="font-size: 0.7rem;"
                      ) {{tag.trim()}}
                  button.btn.btn-sm.btn-outline-warning(
                    type="button"
                    ng-click="editAlbumTag(folder)"
                    title="Edit tags for this album"
                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                  )
                    i.fas.fa-tags
            
            //- Playlists list (filtered)
            ul.list-group.list-group-flush.playlists-list(ng-if="selectedView === 'playlists'")
              li.list-group-item.list-group-item-action.playlist-item(
                ng-repeat="playlist in getFilteredPlaylists()"
                ng-class="{'active': playlist.id == selectedAlbum.id}"
                title="{{playlist.name}} - {{playlist.item_count}} items"
                style="position: relative; padding-right: 80px;"
              )
                div.d-flex.justify-content-between.align-items-center
                  div(ng-click="setPlaylist(playlist)" style="flex-grow: 1; cursor: pointer;")
                    div.playlist-name
                      i.fas.fa-list.me-2
                      span {{playlist.name}}
                      span.badge.bg-secondary.ms-2 {{playlist.item_count || 0}}
                    //- Display playlist tags if they exist
                    div.playlist-tags(ng-if="playlist.tags && playlist.tags.trim()" style="margin-top: 0.3rem; margin-left: 1.5rem;")
                      span.badge.bg-success.me-1(
                        ng-repeat="tag in playlist.tags.split(',')"
                        ng-if="tag.trim()"
                        style="font-size: 0.7rem;"
                      ) {{tag.trim()}}
                  button.btn.btn-sm.btn-outline-info(
                    type="button"
                    ng-click="editPlaylistTag(playlist)"
                    title="Edit tags for this playlist"
                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                  )
                    i.fas.fa-tags
                  button.btn.btn-sm.btn-outline-danger(
                    type="button"
                    ng-click="removePlaylist(playlist)"
                    title="Delete this playlist"
                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                  )
                    i.fas.fa-trash
            
            //- No results message
            div.albums-no-results(
              ng-if="selectedView === 'albums' && albumsSearchText.trim() && getFilteredFolders().length === 0"
            )
              i.fas.fa-search.me-2
              | No albums found
            
            //- No results message for playlists
            div.albums-no-results(
              ng-if="selectedView === 'playlists' && playlistsSearchText.trim() && getFilteredPlaylists().length === 0"
            )
              i.fas.fa-search.me-2
              | No playlists found

        // Main Content
        main(ng-class="{'col-md-10': folders.length > 0, 'col-12': folders.length == 0}")
          // Gallery Grid
          div.row.g-3
            div.col-sm-6.col-md-4.col-lg-3(ng-repeat="image in photos")
              div.card.shadow-sm(style="position: relative;")
                //- Checkbox for bulk operations
                input.photo-checkbox(
                  type="checkbox"
                  ng-attr-data-photo-id="{{image.path}}"
                  style="position: absolute; bottom: 10px; right: 10px; z-index: 5; width: 20px; height: 20px; cursor: pointer;"
                  title="Select for bulk operations"
                )
                //- Now Playing Indicator for audio
                div.now-playing-badge(
                  ng-if="image.isAudio && currentIndex >= 0 && isPlaying && (playlist[currentIndex] || {}).path === image.path"
                  style="position: absolute; top: 10px; left: 10px; z-index: 5;"
                )
                  span.badge.bg-success(
                    style="animation: pulse 1.5s infinite;"
                  )
                    i.fas.fa-volume-up.me-1
                    | Now Playing
                
                //- Audio file - clickable to play
                a(
                  ng-if="image.isAudio"
                  href="javascript:void(0)"
                  ng-click="playAudio(image)"
                  title="Click to play"
                )
                  figure(style="position: relative;")
                    img.card-img-top.img-fluid(
                      ng-src="music.png"
                      alt="{{image.tags}}"
                      loading="lazy"
                      style="object-fit: contain; width: 100%; height: auto;"
                    )
                    i.overlay-icon.fas.fa-play-circle(
                      style="font-size: 3rem;"
                    )
                
                //- Non-audio files - fancybox
                a(
                  ng-if="!image.isAudio"
                  ng-href="{{image.path}}"
                  data-fancybox="gallery"
                  data-caption="{{image.tags}}"
                  ng-attr-data-type="{{image.isVideo ? 'video' : (image.isPdf ? 'iframe' : 'image')}}"
                  ng-attr-data-width="{{image.isVideo ? '640' : undefined}}"
                  ng-attr-data-height="{{image.isVideo ? '360' : undefined}}"
                )
                  figure
                    img.card-img-top.img-fluid(
                      ng-src="{{image.isAudio ? 'music.png' : (image.isVideo ? '/thumbs?id=' + image.path + '&w=300&h=200' : (image.isPdf ? 'pdf.png' : '/thumbs?id=' + image.path + '&w=300&h=200'))}}"
                      alt="{{image.tags}}"
                      loading="lazy"
                      style="object-fit: contain; width: 100%; height: auto;"
                    )
                    i.overlay-icon(
                      ng-class="{'fas fa-play-circle': image.isVideo,'fas fa-file-pdf': image.isPdf,'fas fa-music': image.isAudio,'fas fa-search-plus': image.isPhoto}"
                    )
                div.card-body.p-2
                  h6.card-title.mb-1.text-truncate
                    a.text-decoration-none.text-dark(
                      href="javascript:void(0)"
                      ng-click="editImageTag(image)"
                      title="Edit tags"
                    ) {{image.tags || (image.name | stripExtension) || 'Untitled'}}
                  
                  //- Action buttons for advanced features
                  //- For photos and videos
                  div.d-flex.gap-1.mt-2(ng-if="!image.isAudio && !image.isPdf")
                    button.btn.btn-sm.btn-outline-info(
                      type="button"
                      ng-click="showExifModal(image)"
                      title="View EXIF data"
                    )
                      i.fas.fa-camera.fa-sm
                    
                    button.btn.btn-sm.btn-outline-danger(
                      type="button"
                      ng-click="toggleFavorite(image)"
                      ng-class="{'active': image.isFavorite}"
                      title="Favorite"
                    )
                      i.fas.fa-heart.fa-sm
                    
                    button.btn.btn-sm.btn-outline-success(
                      type="button"
                      ng-click="sharePhoto(image)"
                      title="Share photo"
                    )
                      i.fas.fa-share-alt.fa-sm
                    
                    //- Show "Remove from Playlist" when viewing a playlist
                    button.btn.btn-sm.btn-outline-warning(
                      type="button"
                      ng-click="removePlaylistItem(image.id)"
                      ng-if="selectedAlbum.isPlaylist"
                      title="Remove from this playlist"
                    )
                      i.fas.fa-times.fa-sm
                  
                  //- For audio files
                  div.d-flex.gap-1.mt-2(ng-if="image.isAudio")
                    button.btn.btn-sm.btn-outline-primary(
                      type="button"
                      ng-click="playAudio(image)"
                      title="Play audio"
                    )
                      i.fas.fa-play.fa-sm
                    
                    button.btn.btn-sm.btn-outline-danger(
                      type="button"
                      ng-click="toggleFavorite(image)"
                      ng-class="{'active': image.isFavorite}"
                      title="Favorite"
                    )
                      i.fas.fa-heart.fa-sm
                    
                    button.btn.btn-sm.btn-outline-success(
                      type="button"
                      ng-click="sharePhoto(image)"
                      title="Share"
                    )
                      i.fas.fa-share-alt.fa-sm
                    
                    button.btn.btn-sm.btn-outline-secondary(
                      type="button"
                      ng-click="addToPlaylistQueue(image)"
                      title="Add to playlist"
                    )
                      i.fas.fa-list.fa-sm
        // Audio Player Bar
        div#playerBar.fixed-bottom.bg-light.border-top.shadow-lg(ng-if="playlist.length > 0" style="z-index: 1030;")
          div.p-2
            div.d-flex.align-items-center.justify-content-between.mb-2
              div.d-flex.align-items-center.flex-grow-1
                i.fas.fa-music.me-2.text-primary
                div.flex-grow-1
                  strong.d-block.text-truncate(style="max-width: 250px;") {{ playlist[currentIndex].tags || 'Untitled' }}
                  small.text-muted Track {{currentIndex + 1}} of {{playlist.length}}
              
              //- Playlist toggle button
              button.btn.btn-sm.btn-outline-secondary(
                ng-click="showPlaylist = !showPlaylist"
                title="Toggle playlist"
              )
                i.fas.fa-list.me-1
                | Playlist ({{playlist.length}})
                i.fas(
                  ng-class="{'fa-chevron-up': showPlaylist, 'fa-chevron-down': !showPlaylist}"
                  style="margin-left: 4px;"
                )

            div.d-flex.align-items-center
              // Controls
              button.btn.btn-sm.btn-outline-secondary.me-2(ng-click="prev()" title="Previous")
                i.fas.fa-backward
              button.btn.btn-sm.btn-primary.me-2(ng-click="togglePlay()" title="Play/Pause" style="width: 40px;")
                i(ng-class="{'fas fa-pause': isPlaying, 'fas fa-play': !isPlaying}")
              button.btn.btn-sm.btn-outline-secondary.me-2(ng-click="next()" title="Next")
                i.fas.fa-forward
              
              button.btn.btn-sm.btn-outline-secondary.me-2(
                ng-click="toggleRepeat()"
                ng-class="{'btn-success': isRepeat}"
                title="Repeat"
              )
                i.fas.fa-redo
              
              button.btn.btn-sm.btn-outline-secondary.me-2(
                ng-click="toggleShuffle()"
                ng-class="{'btn-success': isShuffle}"
                title="Shuffle"
              )
                i.fas.fa-random

              // Progress bar
              div.flex-grow-1.mx-2.progress(
                ng-click="seek($event)"
                style="height:8px; cursor:pointer;"
              )
                div.progress-bar.bg-primary(style="width:{{progress}}%;")

              small.text-muted.ms-2(style="min-width: 80px; text-align: right;") {{ currentTime }} / {{ duration }}
              
              //- Volume control
              div.ms-2.d-flex.align-items-center
                i.fas.fa-volume-up.me-1
                input.form-range(
                  type="range"
                  min="0"
                  max="100"
                  ng-model="volume"
                  ng-change="setVolume()"
                  style="width: 80px;"
                  title="Volume"
                )

          // Collapsible Playlist display
          div.playlist-container(
            ng-if="showPlaylist"
            style="max-height:200px; overflow-y:auto; border-top: 1px solid #dee2e6;"
          )
            ul.list-group.list-group-flush
              li.list-group-item.d-flex.justify-content-between.align-items-center(
                ng-repeat="track in playlist track by $index"
                ng-class="{'active bg-primary text-white': $index === currentIndex}"
                ng-click="playTrackByIndex($index)"
                style="cursor:pointer; padding: 8px 12px;"
              )
                div.d-flex.align-items-center.flex-grow-1
                  i.fas(
                    ng-class="{'fa-volume-up': $index === currentIndex && isPlaying, 'fa-music': $index !== currentIndex || !isPlaying}"
                    style="margin-right: 8px;"
                  )
                  span.text-truncate(style="max-width: 300px;") {{ track.tags || 'Untitled' }}
                button.btn.btn-sm.btn-link.text-danger(
                  ng-click="removeFromPlaylist($index); $event.stopPropagation();"
                  title="Remove from playlist"
                  style="padding: 0; margin-left: 8px;"
                )
                  i.fas.fa-times   
      button#goTopBtn.btn.btn-primary.rounded-circle.shadow(
        ng-click="scrollToTop()"
        title="Go to top"
      )
        i.fas.fa-arrow-up

      //- Cache Stats Modal
      div.modal.fade#cacheStatsModal(tabindex="-1" aria-labelledby="cacheStatsLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered.modal-lg
          div.modal-content
            div.modal-header.bg-light
              h5.modal-title#cacheStatsLabel
                i.fas.fa-chart-pie.me-2
                | Cache Statistics
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              //- Stats Summary
              div.row.mb-4
                div.col-md-4
                  div.card.border-primary
                    div.card-body
                      h6.card-title.text-primary
                        i.fas.fa-database.me-2
                        | Performance
                      p.mb-1
                        small.text-muted Cache Hit Rate:
                        br
                        strong {{cacheStats.hitRate}}
                      p.mb-1
                        small.text-muted Total Hits:
                        br
                        strong {{cacheStats.hits}}
                      p.mb-0
                        small.text-muted Total Misses:
                        br
                        strong {{cacheStats.misses}}
                div.col-md-4
                  div.card.border-success
                    div.card-body
                      h6.card-title.text-success
                        i.fas.fa-memory.me-2
                        | Memory Usage
                      p.mb-1
                        small.text-muted Cache Size:
                        br
                        strong {{cacheStats.cacheSizeMB}} MB
                      p.mb-1
                        small.text-muted Max Size:
                        br
                        strong {{cacheStats.maxCacheBytes}} MB
                      p.mb-0
                        small.text-muted Entries:
                        br
                        strong {{cacheStats.cacheEntries}} / {{cacheStats.maxCacheEntries}}
                div.col-md-4
                  div.card.border-info
                    div.card-body
                      h6.card-title.text-info
                        i.fas.fa-folder-open.me-2
                        | Album Discovery
                      p.mb-1
                        small.text-muted Albums Tracked:
                        br
                        strong {{cacheStats.totalAlbumsTracked || 0}}
                      p.mb-1
                        small.text-muted Scan Frequency:
                        br
                        strong Every 15 min
                      p.mb-0
                        small.text-muted
                          a(href="#" ng-click="scanForNewAlbums()" style="text-decoration: none;")
                            i.fas.fa-sync.me-1
                            | Scan Now
              
              //- Top Albums Table
              div(ng-if="topAlbums.length > 0")
                h6.text-muted.mb-3
                  i.fas.fa-star.me-2
                  | Most Accessed Albums
                div.table-responsive
                  table.table.table-sm.table-hover
                    thead.table-light
                      tr
                        th Album
                        th Hits
                        th Last Indexed
                    tbody
                      tr(ng-repeat="album in topAlbums")
                        td
                          span.text-truncate(title="{{album.album}}")
                            i.fas.fa-folder.me-1
                            | {{album.album | limitTo:40}}
                        td
                          span.badge.bg-info {{album.hits}}
                        td
                          small.text-muted {{album.lastIndexed | date:'short'}}
            div.modal-footer
              button.btn.btn-outline-danger(
                type="button"
                ng-click="clearAllCache()"
                ng-disabled="!cacheStats.cacheEntries"
              )
                i.fas.fa-trash.me-1
                | Clear All
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal")
                i.fas.fa-times.me-1
                | Close

      //- Edit Tags Modal (for existing photos)
      div.modal.fade#editTagModal(tabindex="-1" aria-labelledby="editTagModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#editTagModalLabel
                i.fas.fa-tags.me-2
                | Edit Photo Tags
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              div.mb-3(ng-if="selectedPhoto.tags")
                h6.text-muted.mb-2
                  i.fas.fa-th.me-2
                  | Current Tags
                div(ng-repeat="tag in selectedPhoto.tags.split(',')" ng-if="selectedPhoto.tags")
                  span.badge.bg-secondary.me-1 {{tag.trim()}}
              div.mb-3
                label.form-label Tags
                textarea.form-control(
                  ng-model="selectedPhoto.tags"
                  rows="4"
                  placeholder="Enter tags (comma-separated) or detailed description"
                  required
                )
                small.text-muted
                  | You can: 1) Select and copy a tag from above, 2) Manually type/edit tags, 3) Add comma-separated tags

            div.modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
              button.btn.btn-outline-danger(
                type="button"
                ng-click="clearTagText()"
                ng-if="selectedPhoto.tags && selectedPhoto.tags.trim() !== ''"
                title="Clear all text"
              )
                i.fas.fa-eraser.me-1
                | Clear
              button.btn.btn-primary(
                type="button"
                ng-click="submitEditTagForm()"
                data-bs-dismiss="modal"
                ng-disabled="!selectedPhoto.tags || selectedPhoto.tags.trim() === ''"
              ) 
                i.fas.fa-save.me-1
                | Update

      //- Search Modal
      div.modal.fade#searchModal(tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#searchModalLabel
                i.fas.fa-search.me-2
                | Search Photos
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              //- Search input with clear button
              div.position-relative.mb-3
                input.form-control#searchInput(
                  type="text"
                  placeholder="Type to search..."
                  ng-model="searchTag"
                  ng-keypress="($event.which === 13) && search()"
                  autofocus
                )
                button.btn-search-clear(
                  ng-show="searchTag"
                  ng-click="searchTag = ''"
                  type="button"
                  title="Clear search"
                )
                  i.fas.fa-times
              //- Tags section
              div(ng-if="filteredTags.length > 0")
                div.d-flex.justify-content-between.align-items-center.mb-2
                  h6.text-muted.mb-0
                    i.fas.fa-tags.me-2
                    | Available Tags
                  span.badge.bg-info {{filteredTags.length}} tags
                div.d-flex.flex-wrap.gap-2(style="max-height: 200px; overflow-y: auto;")
                  a.badge.bg-secondary.text-white.text-decoration-none(
                    ng-repeat="tag in filteredTags"
                    ng-click="searchByTag(tag.tag)"
                    style="cursor: pointer;"
                    title="Click to search for {{tag.tag}}"
                  ) {{tag.tag}}
            div.modal-footer.d-flex.justify-content-between
              button.btn.btn-outline-secondary(
                type="button"
                ng-click="searchTag = ''"
                ng-disabled="!searchTag"
              )
                i.fas.fa-eraser.me-1
                | Clear
              div
                button.btn.btn-secondary.me-2(type="button" data-bs-dismiss="modal")
                  i.fas.fa-times.me-1
                  | Cancel
                button.btn.btn-primary(
                  type="button"
                  ng-click="search()"
                  ng-disabled="!searchTag || searchTag.trim() === ''"
                  data-bs-dismiss="modal"
                )
                  i.fas.fa-search.me-1
                  | Search
      
      //- EXIF Details Modal
      div.modal.fade#exifModal(tabindex="-1" aria-labelledby="exifModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered.modal-lg(style="max-width: 90vw;")
          div.modal-content
            div.modal-header.d-flex.justify-content-between.align-items-center
              div.d-flex.align-items-center.gap-2
                button.btn.btn-sm.btn-outline-secondary(
                  type="button"
                  data-bs-dismiss="modal"
                  title="Go back"
                  style="padding: 0.25rem 0.5rem;"
                )
                  i.fas.fa-arrow-left
                h5.modal-title#exifModalLabel ðŸ“¸ Photo Details
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body#exif-modal-body(style="max-height: 70vh; overflow-y: auto;")
              p.text-center.text-muted Loading EXIF data...
            div.modal-footer
              button.btn.btn-secondary(
                type="button"
                data-bs-dismiss="modal"
                style="width: 100%;"
              ) 
                i.fas.fa-times.me-1
                | Close

      //- Edit Album Tags Modal
      div.modal.fade#editAlbumTagModal(tabindex="-1" aria-labelledby="editAlbumTagModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#editAlbumTagModalLabel
                i.fas.fa-folder-open.me-2
                | Edit Album Tags
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              div.mb-3(ng-if="editingAlbum.name")
                h6.text-muted.mb-2
                  i.fas.fa-folder-open.me-2
                  | {{editingAlbum.name}}
              div.mb-3(ng-if="editingAlbum.tags")
                h6.text-muted.mb-2
                  i.fas.fa-th.me-2
                  | Current Tags
                div(ng-repeat="tag in editingAlbum.tags.split(',')" ng-if="editingAlbum.tags")
                  span.badge.bg-secondary.me-1 {{tag.trim()}}
              div.mb-3
                label.form-label Tags
                textarea.form-control(
                  ng-model="editingAlbum.tags"
                  rows="4"
                  placeholder="Enter tags (comma-separated) for this album"
                )
                small.text-muted
                  | Add tags to organize and search your albums easily
            
            div.modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
              button.btn.btn-outline-danger(
                type="button"
                ng-click="clearAlbumTagText()"
                ng-if="editingAlbum.tags && editingAlbum.tags.trim() !== ''"
                title="Clear all text"
              )
                i.fas.fa-eraser.me-1
                | Clear
              button.btn.btn-primary(
                type="button"
                ng-click="submitEditAlbumTagForm()"
                data-bs-dismiss="modal"
              ) 
                i.fas.fa-save.me-1
                | Update
      
      //- Create Playlist Modal
      div.modal.fade#createPlaylistModal(tabindex="-1" aria-labelledby="createPlaylistModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#createPlaylistModalLabel
                i.fas.fa-list.me-2
                | Create New Playlist
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              div.mb-3
                label.form-label Playlist Name
                input.form-control(
                  type="text"
                  ng-model="editingPlaylist.name"
                  placeholder="Enter playlist name"
                  required
                )
              div.mb-3
                label.form-label Description
                textarea.form-control(
                  ng-model="editingPlaylist.description"
                  rows="2"
                  placeholder="Optional description for this playlist"
                )
              div.mb-3
                label.form-label Tags
                textarea.form-control(
                  ng-model="editingPlaylist.tags"
                  rows="3"
                  placeholder="Enter tags (comma-separated) for this playlist"
                )
                small.text-muted
                  | Add tags to organize and search your playlists easily
            
            div.modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
              button.btn.btn-success(
                type="button"
                ng-click="createNewPlaylist()"
              ) 
                i.fas.fa-plus.me-1
                | Create Playlist
      
      //- Edit Playlist Tags Modal
      div.modal.fade#editPlaylistTagModal(tabindex="-1" aria-labelledby="editPlaylistTagModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#editPlaylistTagModalLabel
                i.fas.fa-list.me-2
                | Edit Playlist Tags
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              div.mb-3(ng-if="editingPlaylist.name")
                h6.text-muted.mb-2
                  i.fas.fa-list.me-2
                  | {{editingPlaylist.name}}
              div.mb-3(ng-if="editingPlaylist.tags")
                h6.text-muted.mb-2
                  i.fas.fa-th.me-2
                  | Current Tags
                div(ng-repeat="tag in editingPlaylist.tags.split(',')" ng-if="editingPlaylist.tags")
                  span.badge.bg-secondary.me-1 {{tag.trim()}}
              div.mb-3
                label.form-label Tags
                textarea.form-control(
                  ng-model="editingPlaylist.tags"
                  rows="4"
                  placeholder="Enter tags (comma-separated) for this playlist"
                )
                small.text-muted
                  | Add tags to organize and search your playlists easily
            
            div.modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
              button.btn.btn-outline-danger(
                type="button"
                ng-click="clearPlaylistTagText()"
                ng-if="editingPlaylist.tags && editingPlaylist.tags.trim() !== ''"
                title="Clear all text"
              )
                i.fas.fa-eraser.me-1
                | Clear
              button.btn.btn-primary(
                type="button"
                ng-click="submitEditPlaylistTagForm()"
                data-bs-dismiss="modal"
              ) 
                i.fas.fa-save.me-1
                | Update
      
      //- File upload Modal
      div.modal.fade#uploadModal(tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true")
        div.modal-dialog.modal-dialog-centered
          div.modal-content
            div.modal-header
              h5.modal-title#uploadModalLabel Upload File
              button.btn-close(type="button", data-bs-dismiss="modal" aria-label="Close")
            div.modal-body
              form(name="uploadForm" novalidate)
                div.mb-3
                  label.form-label(for="uploadFile") Select File                  
                  input.form-control(type="file" id="uploadFile" name="myFile" file-model="uploadFile" accept="*/*" required)
                img.img-fluid.mt-2(ng-if="filePreviewUrl" ng-src="{{filePreviewUrl}}")
                div.mb-3
                  label.form-label Enter file description
                  textarea.form-control(name="tags" ng-model="uploadTags" rows="3")
                div.mb-3
                  label.form-label Select folder OR enter name
                  div.d-flex.gap-2
                    select.form-select(
                      ng-model="uploadAlbum"
                      ng-options="album.path as album.name for album in albums"
                    )
                    input.form-control(type="text" name="album" ng-model="uploadAlbum")
            div.modal-footer
              button.btn.btn-primary(type="button" ng-click="submitUploadForm()" data-bs-dismiss="modal") Upload
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
    // Scripts
    script(src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.18/angular-ui-router.min.js")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
    script(src="jquery/jquery.min.js")
    script(src="jquery.fancybox.min.js")
    script(src="js/constants.js")
    script(src="js/ng-app.js")    
    script(src="main.js")
    script(src="js/controllers/photoController.js?v=9")
    script(src="js/directives/modalDirective.js")
    script(src="js/directives/fileModelDirective.js")
    script(src="js/directives/shrinkHeaderDirective.js")
    script(src="js/services/photoService.js")
    script(src="js/services/modalService.js")
    script(src="js/services/recentlyViewedService.js")
    script(src="js/services/searchService.js")
    script(src="js/services/utilityService.js")
    script(src="js/services/errorHandlingService.js")
    script(src="js/services/taggingService.js")
    script(src="js/services/audioPlayerService.js")
    
    //- Advanced Features Components
    script(src="js/advanced-search.js")
    script(src="js/exif-display.js")
    script(src="js/bulk-operations.js")
    script(src="js/social-features.js")
    script(src="js/advanced-features-angular-integration.js")
    
